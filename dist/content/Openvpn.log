+ trap killjobs INT TERM EXIT
+ echo

++ date
+ echo '=== Recipe Openvpn started at Wed Jun 19 18:12:50 EDT 2019 ==='
=== Recipe Openvpn started at Wed Jun 19 18:12:50 EDT 2019 ===
+ echo

+ '[' -f /etc/redhat-release ']'
+ OSNAME=debian
+ '[' debian = debian ']'
+ export DEBIAN_FRONTEND=noninteractive
+ DEBIAN_FRONTEND=noninteractive
+ apt-get update
Get:1 http://archive.ubuntu.com/ubuntu xenial InRelease [247 kB]
Get:2 http://archive.ubuntu.com/ubuntu xenial-updates InRelease [109 kB]
Get:3 http://archive.canonical.com/ubuntu xenial InRelease [11.5 kB]
Get:4 http://archive.ubuntu.com/ubuntu xenial/main amd64 Packages [1201 kB]
Get:5 http://archive.canonical.com/ubuntu xenial/partner amd64 Packages [3140 B]
Get:6 http://archive.canonical.com/ubuntu xenial/partner Translation-en [1620 B]
Get:7 http://archive.ubuntu.com/ubuntu xenial/main Translation-en [568 kB]
Get:8 http://archive.ubuntu.com/ubuntu xenial/restricted amd64 Packages [8344 B]
Get:9 http://archive.ubuntu.com/ubuntu xenial/restricted Translation-en [2908 B]
Get:10 http://archive.ubuntu.com/ubuntu xenial/universe amd64 Packages [7532 kB]
Get:11 http://security.ubuntu.com/ubuntu xenial-security InRelease [109 kB]
Get:12 http://security.ubuntu.com/ubuntu xenial-security/main amd64 Packages [679 kB]
Get:13 http://archive.ubuntu.com/ubuntu xenial/universe Translation-en [4354 kB]
Get:14 http://security.ubuntu.com/ubuntu xenial-security/main Translation-en [272 kB]
Get:15 http://security.ubuntu.com/ubuntu xenial-security/restricted amd64 Packages [7204 B]
Get:16 http://security.ubuntu.com/ubuntu xenial-security/restricted Translation-en [2152 B]
Get:17 http://security.ubuntu.com/ubuntu xenial-security/universe amd64 Packages [440 kB]
Get:18 http://security.ubuntu.com/ubuntu xenial-security/universe Translation-en [179 kB]
Get:19 http://archive.ubuntu.com/ubuntu xenial-updates/main amd64 Packages [976 kB]
Get:20 http://security.ubuntu.com/ubuntu xenial-security/multiverse amd64 Packages [5604 B]
Get:21 http://security.ubuntu.com/ubuntu xenial-security/multiverse Translation-en [2676 B]
Get:22 http://archive.ubuntu.com/ubuntu xenial-updates/main Translation-en [386 kB]
Get:23 http://archive.ubuntu.com/ubuntu xenial-updates/restricted amd64 Packages [7616 B]
Get:24 http://archive.ubuntu.com/ubuntu xenial-updates/restricted Translation-en [2272 B]
Get:25 http://archive.ubuntu.com/ubuntu xenial-updates/universe amd64 Packages [752 kB]
Get:26 http://archive.ubuntu.com/ubuntu xenial-updates/universe Translation-en [313 kB]
Fetched 18.2 MB in 6s (3026 kB/s)
Reading package lists...
+ test -f /usr/bin/which
+ which lsb_release
/usr/bin/lsb_release
+ which logger
/usr/bin/logger
++ lsb_release -s -c
+ OSREL=xenial
+ pkglist='openvpn openssl'
+ '[' xxenial '!=' xwheezy ']'
+ pkglist='openvpn openssl easy-rsa'
+ easyrsa_path=/usr/share/easy-rsa
+ apt-get -y install openvpn openssl easy-rsa
Reading package lists...
Building dependency tree...
The following additional packages will be installed:
  libccid liblzo2-2 libpcsclite1 libpkcs11-helper1 libusb-1.0-0 opensc
  opensc-pkcs11 pcscd
Suggested packages:
  pcmciautils resolvconf
The following NEW packages will be installed:
  easy-rsa libccid liblzo2-2 libpcsclite1 libpkcs11-helper1 libusb-1.0-0
  opensc opensc-pkcs11 openvpn pcscd
The following packages will be upgraded:
  openssl
1 upgraded, 10 newly installed, 0 to remove and 193 not upgraded.
Need to get 2148 kB of archives.
After this operation, 5375 kB of additional disk space will be used.
Get:1 http://archive.ubuntu.com/ubuntu xenial/main amd64 liblzo2-2 amd64 2.08-1.2 [48.7 kB]
Get:2 http://archive.ubuntu.com/ubuntu xenial/main amd64 libusb-1.0-0 amd64 2:1.0.20-1 [42.9 kB]
Get:3 http://archive.ubuntu.com/ubuntu xenial-updates/main amd64 openssl amd64 1.0.2g-1ubuntu4.15 [492 kB]
Get:4 http://archive.ubuntu.com/ubuntu xenial-updates/main amd64 libpcsclite1 amd64 1.8.14-1ubuntu1.16.04.1 [21.4 kB]
Get:5 http://archive.ubuntu.com/ubuntu xenial/main amd64 libpkcs11-helper1 amd64 1.11-5 [44.0 kB]
Get:6 http://archive.ubuntu.com/ubuntu xenial/universe amd64 opensc-pkcs11 amd64 0.15.0-1ubuntu1 [708 kB]
Get:7 http://archive.ubuntu.com/ubuntu xenial-updates/universe amd64 libccid amd64 1.4.22-1ubuntu0.1 [85.8 kB]
Get:8 http://archive.ubuntu.com/ubuntu xenial-updates/universe amd64 pcscd amd64 1.8.14-1ubuntu1.16.04.1 [55.7 kB]
Get:9 http://archive.ubuntu.com/ubuntu xenial/universe amd64 opensc amd64 0.15.0-1ubuntu1 [212 kB]
Get:10 http://archive.ubuntu.com/ubuntu xenial-updates/main amd64 openvpn amd64 2.3.10-1ubuntu2.2 [420 kB]
Get:11 http://archive.ubuntu.com/ubuntu xenial/universe amd64 easy-rsa all 2.2.2-2 [17.4 kB]
Preconfiguring packages ...
Fetched 2148 kB in 0s (3431 kB/s)
Selecting previously unselected package liblzo2-2:amd64.
(Reading database ... (Reading database ... 5%(Reading database ... 10%(Reading database ... 15%(Reading database ... 20%(Reading database ... 25%(Reading database ... 30%(Reading database ... 35%(Reading database ... 40%(Reading database ... 45%(Reading database ... 50%(Reading database ... 55%(Reading database ... 60%(Reading database ... 65%(Reading database ... 70%(Reading database ... 75%(Reading database ... 80%(Reading database ... 85%(Reading database ... 90%(Reading database ... 95%(Reading database ... 100%(Reading database ... 26041 files and directories currently installed.)
Preparing to unpack .../liblzo2-2_2.08-1.2_amd64.deb ...
Unpacking liblzo2-2:amd64 (2.08-1.2) ...
Selecting previously unselected package libusb-1.0-0:amd64.
Preparing to unpack .../libusb-1.0-0_2%3a1.0.20-1_amd64.deb ...
Unpacking libusb-1.0-0:amd64 (2:1.0.20-1) ...
Preparing to unpack .../openssl_1.0.2g-1ubuntu4.15_amd64.deb ...
Unpacking openssl (1.0.2g-1ubuntu4.15) over (1.0.2g-1ubuntu4.5) ...
Selecting previously unselected package libpcsclite1:amd64.
Preparing to unpack .../libpcsclite1_1.8.14-1ubuntu1.16.04.1_amd64.deb ...
Unpacking libpcsclite1:amd64 (1.8.14-1ubuntu1.16.04.1) ...
Selecting previously unselected package libpkcs11-helper1:amd64.
Preparing to unpack .../libpkcs11-helper1_1.11-5_amd64.deb ...
Unpacking libpkcs11-helper1:amd64 (1.11-5) ...
Selecting previously unselected package opensc-pkcs11:amd64.
Preparing to unpack .../opensc-pkcs11_0.15.0-1ubuntu1_amd64.deb ...
Unpacking opensc-pkcs11:amd64 (0.15.0-1ubuntu1) ...
Selecting previously unselected package libccid.
Preparing to unpack .../libccid_1.4.22-1ubuntu0.1_amd64.deb ...
Unpacking libccid (1.4.22-1ubuntu0.1) ...
Selecting previously unselected package pcscd.
Preparing to unpack .../pcscd_1.8.14-1ubuntu1.16.04.1_amd64.deb ...
Unpacking pcscd (1.8.14-1ubuntu1.16.04.1) ...
Selecting previously unselected package opensc.
Preparing to unpack .../opensc_0.15.0-1ubuntu1_amd64.deb ...
Unpacking opensc (0.15.0-1ubuntu1) ...
Selecting previously unselected package openvpn.
Preparing to unpack .../openvpn_2.3.10-1ubuntu2.2_amd64.deb ...
Unpacking openvpn (2.3.10-1ubuntu2.2) ...
Selecting previously unselected package easy-rsa.
Preparing to unpack .../easy-rsa_2.2.2-2_all.deb ...
Unpacking easy-rsa (2.2.2-2) ...
Processing triggers for libc-bin (2.23-0ubuntu4) ...
Processing triggers for man-db (2.7.5-1) ...
Processing triggers for systemd (229-4ubuntu12) ...
Setting up liblzo2-2:amd64 (2.08-1.2) ...
Setting up libusb-1.0-0:amd64 (2:1.0.20-1) ...
Setting up openssl (1.0.2g-1ubuntu4.15) ...
Setting up libpcsclite1:amd64 (1.8.14-1ubuntu1.16.04.1) ...
Setting up libpkcs11-helper1:amd64 (1.11-5) ...
Setting up opensc-pkcs11:amd64 (0.15.0-1ubuntu1) ...
Setting up libccid (1.4.22-1ubuntu0.1) ...
Setting up pcscd (1.8.14-1ubuntu1.16.04.1) ...
Setting up opensc (0.15.0-1ubuntu1) ...
Setting up openvpn (2.3.10-1ubuntu2.2) ...
 * Restarting virtual private network daemon(s)...       [80G  [33m*[39;49m   No VPN is running.
Setting up easy-rsa (2.2.2-2) ...
Processing triggers for libc-bin (2.23-0ubuntu4) ...
Processing triggers for systemd (229-4ubuntu12) ...
+ '[' xxenial = xxenial ']'
+ vpnservice=openvpn@server
+ cd /etc/openvpn
+ cp -aL /usr/share/easy-rsa easy-rsa
+ '[' '' '!=' 3 ']'
+ cd easy-rsa
+ '[' xxenial = xbionic ']'
+ . ./vars
+++ pwd
++ export EASY_RSA=/etc/openvpn/easy-rsa
++ EASY_RSA=/etc/openvpn/easy-rsa
++ export OPENSSL=openssl
++ OPENSSL=openssl
++ export PKCS11TOOL=pkcs11-tool
++ PKCS11TOOL=pkcs11-tool
++ export GREP=grep
++ GREP=grep
+++ /etc/openvpn/easy-rsa/whichopensslcnf /etc/openvpn/easy-rsa
++ export KEY_CONFIG=/etc/openvpn/easy-rsa/openssl-1.0.0.cnf
++ KEY_CONFIG=/etc/openvpn/easy-rsa/openssl-1.0.0.cnf
++ export KEY_DIR=/etc/openvpn/easy-rsa/keys
++ KEY_DIR=/etc/openvpn/easy-rsa/keys
++ echo NOTE: If you run ./clean-all, I will be doing a rm -rf on /etc/openvpn/easy-rsa/keys
NOTE: If you run ./clean-all, I will be doing a rm -rf on /etc/openvpn/easy-rsa/keys
++ export PKCS11_MODULE_PATH=dummy
++ PKCS11_MODULE_PATH=dummy
++ export PKCS11_PIN=dummy
++ PKCS11_PIN=dummy
++ export KEY_SIZE=2048
++ KEY_SIZE=2048
++ export CA_EXPIRE=3650
++ CA_EXPIRE=3650
++ export KEY_EXPIRE=3650
++ KEY_EXPIRE=3650
++ export KEY_COUNTRY=US
++ KEY_COUNTRY=US
++ export KEY_PROVINCE=CA
++ KEY_PROVINCE=CA
++ export KEY_CITY=SanFrancisco
++ KEY_CITY=SanFrancisco
++ export KEY_ORG=Fort-Funston
++ KEY_ORG=Fort-Funston
++ export KEY_EMAIL=me@myhost.mydomain
++ KEY_EMAIL=me@myhost.mydomain
++ export KEY_OU=MyOrganizationalUnit
++ KEY_OU=MyOrganizationalUnit
++ export KEY_NAME=EasyRSA
++ KEY_NAME=EasyRSA
+ ./clean-all
+ /etc/openvpn/easy-rsa/pkitool --batch --initca
Using CA Common Name: Fort-Funston CA
Generating a 2048 bit RSA private key
.........+++
.....+++
writing new private key to 'ca.key'
-----
+ CAPATH=keys/ca.crt
+ /etc/openvpn/easy-rsa/pkitool --batch --server server
Generating a 2048 bit RSA private key
......+++
.........................+++
writing new private key to 'server.key'
-----
Using configuration from /etc/openvpn/easy-rsa/openssl-1.0.0.cnf
Check that the request matches the signature
Signature ok
The Subject's Distinguished Name is as follows
countryName           :PRINTABLE:'US'
stateOrProvinceName   :PRINTABLE:'CA'
localityName          :PRINTABLE:'SanFrancisco'
organizationName      :PRINTABLE:'Fort-Funston'
organizationalUnitName:PRINTABLE:'MyOrganizationalUnit'
commonName            :PRINTABLE:'server'
name                  :PRINTABLE:'EasyRSA'
emailAddress          :IA5STRING:'me@myhost.mydomain'
Certificate is to be certified until Jun 16 22:13:04 2029 GMT (3650 days)

Write out database with 1 new entries
Data Base Updated
+ SERVERKEYPATH=keys/server.key
+ SERVERCRTPATH=keys/server.crt
+ openssl dhparam -out /etc/openvpn/easy-rsa/keys/dh2048.pem 2048
Generating DH parameters, 2048 bit long safe prime, generator 2
This is going to take a long time
.................................+..............................................................................................................................................................+...................................................................................+...................+....................................+.............................................+....+...........................................................................................................................+...............................................................+...+............................+.........................................................................................................................+..................................................................................+..........................+..+.......................................................+...................................................................+..............................................................................................................................................................................................................................................................................................................................................................................................................+.+..................................................................................................................+...............+.................................................................................+............+............................+...................................................................................+..........................................................+...............................................+........................................................................................+...............................................................................+...............................................................................+............................+...............................................................+...............................+.......................................................................................................................+......................+...................................................................................................................+.................................................................................................................+.........................................................................................................................................................+............................................................................+.............................................................................................................................................+....................................................................................................................................................................................+...............................................................................................+........................+..............................................+......................................................................................................................................+...........................................................................................................................+..............................................................................................................+............................................................................................................+...........................................................................................................................................................................................................................................................+...........+.......................................................................................................................................................................................+.........................................................................+...........................................................................+............................................................................................+........................................+....................................................................+........................................................................................................................+.........................+..............................+.............................................................+...........................................................................................................+........................................................................................................................................+..................................................................+..................................................................................................+.........................+..........................................................................................................................................................................................................................................................................................................................................+................+............+.................................+......................................................................................................................................................................................................+........................................................................................................+..............................................+...................................................................................................................................................................................+.+...............+.................................+..............................+....................+............................................................+.....................................................................................................................................................................................................+.............................................................................................................................+....+....................................................................................+...............................................................................................................................+.......................................+.............................................................................................................................+.........+....................................................................................................................................................................................................................................................................................................+................................................................................................................................+........................................................................................................................................................................................................................................................+............................................................................................................................................................................................................................+.....................................+...................................................................................+.........+......................................................................................................................................................+..................................................................+...................................................+........................................................................+...................................................................................+...................................................................................................................................................................................................................................................................+......................+...........................................................................................................................................................................................................+..................................................................+..........................................................................................................................................+........................................................................................................................................................................................+.............................................................................................................+....................................................................................................................................................................................................+.......................................+.....................................................................................................................................................................................................................................................................................................+............+...+................+.............................+..............+............................+.......................................................................+........................................................................+.......................................................+...................................................................+...............................................+............+.................................+...................................................................+..+..............................................................................................................................................................+...........................................+..+.............+............................................................................+................+............................................+...................................................+.............................................................................................................................................+........+.........................................................................................................+.......................................................................................+.......................................................................................+........................................................+..............+...........+.............+..................................................................................................................................................................................................................................+.....................................................................................................................................+.................................................................+.....+........................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................+.....+...........................................................................................................................................................................................................................................................................................................................................................................................+...............................................................................................+.................................+...........................................................+...............................................................................+.......................+.................................+.......................................+...............................................................................................................................................................................................................+.......................+...................+........................+..................................................................+...................................................+....................................+...............................+.....................................................................................................................+...................................+................................................................+....................................................................+.....+..............+........+............................................................................................................+......................................................................++*++*
+ export KEY_NAME=client1
+ KEY_NAME=client1
+ '[' -n '' ']'
+ /etc/openvpn/easy-rsa/pkitool --batch client1
Generating a 2048 bit RSA private key
..............................................+++
..................................................+++
writing new private key to 'client1.key'
-----
Using configuration from /etc/openvpn/easy-rsa/openssl-1.0.0.cnf
Check that the request matches the signature
Signature ok
The Subject's Distinguished Name is as follows
countryName           :PRINTABLE:'US'
stateOrProvinceName   :PRINTABLE:'CA'
localityName          :PRINTABLE:'SanFrancisco'
organizationName      :PRINTABLE:'Fort-Funston'
organizationalUnitName:PRINTABLE:'MyOrganizationalUnit'
commonName            :PRINTABLE:'client1'
name                  :PRINTABLE:'client1'
emailAddress          :IA5STRING:'me@myhost.mydomain'
Certificate is to be certified until Jun 16 22:15:20 2029 GMT (3650 days)

Write out database with 1 new entries
Data Base Updated
+ cat
+ echo net.ipv4.ip_forward=1
+ sysctl -p
net.ipv4.ip_forward = 1
++ awk '{print $3;exit}'
++ ip route get 1
+ ifname=venet0
+ iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o venet0 -j MASQUERADE
iptables v1.6.0: can't initialize iptables table `nat': Table does not exist (do you need to insmod?)
Perhaps iptables or your kernel needs to be upgraded.
+ '[' debian = debian ']'
+ grep -q exit /etc/rc.local
+ sed -i --follow-symlinks '/exit 0/i iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o venet0 -j MASQUERADE' /etc/rc.local
+ chmod +x /etc/rc.local
+ '[' xxenial = xxenial ']'
+ sed -i -r s/LimitNPROC/#LimitNPROC/ /lib/systemd/system/openvpn@.service
+ systemctl daemon-reload
+ Service openvpn@server stop
++ which systemctl
+ '[' -n /bin/systemctl ']'
+ systemctl stop openvpn@server.service
+ Service openvpn@server enable
++ which systemctl
+ '[' -n /bin/systemctl ']'
+ systemctl enable openvpn@server.service
Created symlink from /etc/systemd/system/multi-user.target.wants/openvpn@server.service to /lib/systemd/system/openvpn@.service.
+ Service openvpn@server start
++ which systemctl
+ '[' -n /bin/systemctl ']'
+ systemctl start openvpn@server.service
+ killjobs
++ jobs -p
